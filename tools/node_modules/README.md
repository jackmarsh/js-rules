# Node Modules Tool

## Introduction

The **Node Modules Tool** is a plugin for the [Please](https://please.build) build system, designed to simplify the integration of Node.js modules into Please-based projects. It automates the process of resolving a specified Node.js module and all its dependencies, generating a `BUILD` file with the necessary build targets. This tool streamlines dependency management and build configuration, making it easier to incorporate Node.js modules without the need for manual setup.

---

## Features

- **Automated Dependency Resolution**: Recursively resolves the specified Node.js module and all its dependencies.
- **Build Rule Generation**: Produces a `BUILD` file containing `node_module` build rules for each module and dependency.
- **Seamless Please Integration**: Operates as a Please plugin, eliminating the need to install Go or run additional servers manually.
- **Customizable Registry Support**: Allows specifying a custom NPM registry URL.
- **Configurable Timeout**: Offers the ability to set a timeout for individual dependency resolutions to prevent long waits.
- **Concurrency for Efficiency**: Utilizes concurrent processing to resolve dependencies quickly.
- **Semantic Versioning Compliance**: Correctly handles scoped packages and version constraints using semantic versioning.

---

## How It Works

The tool performs the following steps:

1. **Command-Line Argument Parsing**: Accepts parameters like module name, version, registry URL, output file path, and timeout settings.
2. **Resolver Initialization**: Creates a new resolver instance with the specified registry URL and timeout settings.
3. **Dependency Resolution**:
   - Determines the latest version of the specified module that satisfies the provided version constraint.
   - Fetches the `package.json` for the module from the registry.
   - Parses both dependencies and optional dependencies.
   - Recursively resolves all dependencies, ensuring version constraints are satisfied.
4. **BUILD File Generation**:
   - Aggregates all resolved modules.
   - Generates `node_module` build rules for each module.
   - Writes the build rules to the specified output file.

The tool ensures module names are sanitized for use in build rules and properly handles scoped packages. By leveraging Go's concurrency features, it resolves multiple dependencies in parallel, enhancing performance.

---

## Installation and Setup

As part of the `js-rules` Please plugin, the Node Modules Tool integrates directly into your build system without requiring you to install Go or the tool separately.

### Setting Up the Alias

To use the tool, set up an alias in your project's `.plzconfig` file. This allows you to invoke the tool using the `plz` command.

Add the following to your `.plzconfig`:

```ini
[Alias "node_modules"]
Cmd = run ///js//tools//node_modules --
PositionalLabels = true
Desc = A tool to update BUILD files in JavaScript applications.
```

For personal usage, you can add this alias to your `.plzconfig.local` file instead.

---

## Usage

Invoke the Node Modules Tool via the Please command-line interface:

```bash
plz node_modules [OPTIONS]
```

### Command-Line Options

- `-m, --module_name` **(Required)**: Name of the Node.js module to resolve (e.g., `express`).
- `-v, --module_version` **(Required)**: Version constraint of the module (e.g., `^1.0.0`, `~2.1.5`, `3.0.0`).
- `-r, --registry_url`: NPM registry URL to use (default: `https://registry.yarnpkg.com`).
- `-o, --output`: Output file path for the generated build rules (default: `generated_rules.please`).
- `-t, --timeout`: Timeout in seconds for individual dependency resolution (default: `60` seconds).

### Example

To resolve the module `express` with version constraint `^4.17.1` and generate the build rules:

```bash
plz node_modules \
  --module_name=express \
  --module_version=^4.17.1 \
  --output=BUILD \
  --timeout=30
```

This command will:

- Resolve `express@^4.17.1` and all its dependencies.
- Generate a `BUILD` file with the necessary `node_module` build rules.
- Use a timeout of 30 seconds for each individual dependency resolution.

---

## Integrating with Your Project

Once the `BUILD` file is generated:

1. **Include the BUILD File**: Place the generated `BUILD` file in the appropriate directory within your project.
2. **Update Your BUILD Definitions**: Reference the generated `node_module` targets in your `BUILD` files as needed.
3. **Build Your Project**: Use Please to build your project, and it will include the resolved Node.js modules.

---

## Example Workflow

1. **Resolve Dependencies**:

   ```bash
   plz node_modules \
     --module_name=lodash \
     --module_version=^4.17.21 \
     --output=third_party/javascript/lodash/BUILD
   ```

2. **Reference in BUILD Files**:

   In your project's `BUILD` files, you can now reference `//third_party/javascript/lodash:lodash` as a dependency.

3. **Build Your Project**:

   ```bash
   plz build //path/to:your_target
   ```

---

## Limitations

- **Version Constraints**: The tool depends on semantic versioning; non-standard version specifications may not be supported.
- **Registry Access**: Requires network access to the specified NPM registry.
- **Scoped Packages**: Supports scoped packages; ensure correct scope syntax when specifying module names.

---

## Contributing

Contributions are welcome! Please submit issues and pull requests to help improve this tool.

---

## License

This tool is licensed under the MIT License.

---

If you have any questions or need assistance, feel free to reach out or consult the tool's source code for more details.
